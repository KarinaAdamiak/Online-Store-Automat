version: 2.1
orbs:
  cypress: cypress-io/cypress@2.2.0
workflows:
  build:
    jobs:
        - cypress/install
        - cypress/run:
            requires:
            - cypress/install
            store_artifacts: true
            parallel: true
            parallelism: 2
            steps:
                - checkout
                - node/install-packages:
                pkg-manager: yarn
                - run: mkdir ~/junit
                - run:
                    name: Test application
                command: |
                    TEST=$(circleci tests glob "src/__tests__/*.js" | circleci tests 
split --split-by=timings)
                    yarn test $TEST
            - run:
                command: cp junit.xml ~/junit/
                when: always
            - store_test_results:
                path: ~/junit
            group: 2 machines

